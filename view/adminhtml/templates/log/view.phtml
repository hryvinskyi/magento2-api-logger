<?php
/**
 * Copyright (c) 2025. Volodymyr Hryvinskyi. All rights reserved.
 * Author: Volodymyr Hryvinskyi <volodymyr@hryvinskyi.com>
 * GitHub: https://github.com/hryvinskyi
 */

/**
 * @var \Hryvinskyi\ApiLogger\Block\Adminhtml\Log\View $block
 * @var \Magento\Framework\View\Helper\SecureHtmlRenderer $secureRenderer
 * @var \Magento\Framework\Escaper $escaper
 */
$logEntry = $block->getLogEntry();

if (!$logEntry):
    ?>
    <div class="message message-error">
        <?= $escaper->escapeHtml(__('Log entry not found.')) ?>
    </div>
    <?php
    return;
endif;

$queryParams = $block->getQueryParams();
$requestContentType = $block->getContentTypeBadge($logEntry->getRequestHeaders());
$responseContentType = $block->getContentTypeBadge($logEntry->getResponseHeaders());
$requestLineCount = $block->getLineCount($logEntry->getRequestBody());
$responseLineCount = $block->getLineCount($logEntry->getResponseBody());
$duration = $logEntry->getDuration();

$css = <<<CSS
.log-detail-container {
    background: #fff;
    margin: 20px 0;
    border-radius: 12px;
}
.log-detail-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-bottom: 20px;
    border-bottom: 1px solid #e3e3e3;
    margin-bottom: 24px;
}
.log-detail-title {
    font-size: 24px;
    font-weight: 600;
    color: #4a3f39;
    display: flex;
    align-items: center;
    gap: 10px;
}
.log-detail-actions {
    display: flex;
    gap: 6px;
    align-items: center;
}
.log-action-btn {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 0 14px;
    height: 36px;
    font-size: 13px;
    font-weight: 500;
    color: #4a3f39;
    background: #ffffff;
    border: 1px solid #e3e3e3;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.15s ease;
    text-decoration: none;
    white-space: nowrap;
    letter-spacing: 0.01em;
    line-height: 1;
}
.log-action-btn:hover {
    background: #f5f5f5;
    border-color: #ccc;
    color: #4a3f39;
    text-decoration: none;
}
.log-action-btn:active {
    transform: scale(0.97);
}
.log-action-btn svg {
    width: 15px;
    height: 15px;
    flex-shrink: 0;
    stroke-width: 1.8;
}
.log-action-btn--primary {
    background: #eb5202;
    border-color: #eb5202;
    color: #ffffff;
}
.log-action-btn--primary:hover {
    background: #d44a02;
    border-color: #d44a02;
    color: #ffffff;
}
.log-action-btn--danger {
    color: #c0392b;
    border-color: #e3e3e3;
}
.log-action-btn--danger:hover {
    background: #fdf0ef;
    border-color: #e5a9a3;
    color: #a93226;
}
.log-action-btn--ghost {
    background: transparent;
    border-color: transparent;
    color: #666666;
}
.log-action-btn--ghost:hover {
    background: #f5f5f5;
    border-color: #e3e3e3;
    color: #4a3f39;
}
.log-action-divider {
    width: 1px;
    height: 20px;
    background: #e3e3e3;
    margin: 0 2px;
}
.log-status-badge {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 6px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.3px;
}
.log-status-badge.success {
    background: #d4edda;
    color: #155724;
}
.log-status-badge.warning {
    background: #fff1ad;
    color: #856404;
}
.log-status-badge.error {
    background: #f8d7da;
    color: #721c24;
}
.log-status-badge.info {
    background: #d1ecf1;
    color: #0c5460;
}
.log-detail-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 0;
    margin-bottom: 28px;
    background: #ffffff;
    border: 1px solid #e3e3e3;
    border-radius: 10px;
    overflow: hidden;
}
.log-detail-item {
    padding: 16px 20px;
    border-right: 1px solid #f0f0f0;
    border-bottom: 1px solid #f0f0f0;
    transition: background 0.12s ease;
}
.log-detail-item:hover {
    background: #fafafa;
}
.log-detail-item-label {
    font-size: 10px;
    color: #999;
    text-transform: uppercase;
    font-weight: 600;
    margin-bottom: 6px;
    letter-spacing: 0.5px;
}
.log-detail-item-value {
    font-size: 15px;
    font-weight: 600;
    color: #4a3f39;
    word-break: break-all;
}
.log-detail-section {
    margin-bottom: 24px;
}
.log-detail-section-title {
    font-size: 14px;
    font-weight: 600;
    color: #4a3f39;
    margin-bottom: 8px;
    padding-bottom: 0;
    border-bottom: none;
    display: flex;
    align-items: center;
    gap: 8px;
}
.log-code-block {
    background: #fafafa;
    padding: 16px 20px;
    border-radius: 0 0 10px 10px;
    font-family: 'SFMono-Regular', 'Consolas', 'Liberation Mono', 'Courier New', monospace;
    font-size: 12.5px;
    overflow-x: auto;
    max-height: 500px;
    overflow-y: auto;
    line-height: 1.6;
    border: 1px solid #e3e3e3;
    border-top: none;
}
.log-exception-badge {
    background: #f8d7da;
    color: #721c24;
    padding: 3px 8px;
    border-radius: 5px;
    font-size: 10px;
    font-weight: 700;
    margin-left: 4px;
    letter-spacing: 0.3px;
}

/* Tabs */
.log-tab-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 0;
    padding: 8px 12px;
    background: #ffffff;
    border: 1px solid #e3e3e3;
    border-bottom: none;
    border-radius: 10px 10px 0 0;
}
.log-tab-bar {
    display: flex;
    gap: 2px;
    padding: 2px;
    background: #f0f0f0;
    border-radius: 7px;
}
.log-tab-btn {
    padding: 5px 14px;
    font-size: 11px;
    font-weight: 600;
    color: #666666;
    background: transparent;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    transition: all 0.12s ease;
    text-transform: uppercase;
    letter-spacing: 0.4px;
    line-height: 1;
}
.log-tab-btn:hover {
    color: #4a3f39;
}
.log-tab-btn.active {
    color: #4a3f39;
    background: #ffffff;
    box-shadow: 0 1px 2px rgba(0,0,0,0.06);
}
.log-tab-actions {
    display: flex;
    align-items: center;
    gap: 8px;
}
.log-tab-copy-btn {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    padding: 5px 10px;
    font-size: 10px;
    font-weight: 600;
    color: #666666;
    background: transparent;
    border: 1px solid #e3e3e3;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.12s ease;
    text-transform: uppercase;
    letter-spacing: 0.3px;
}
.log-tab-copy-btn:hover {
    background: #f5f5f5;
    border-color: #ccc;
    color: #4a3f39;
}
.log-tab-copy-btn.copied {
    background: #79a22e;
    color: #ffffff;
    border-color: #79a22e;
}
.log-tab-panel {
    display: none;
}
.log-tab-panel.active {
    display: block;
}
.log-tab-panel .log-code-block {
    border-top: none;
    border-radius: 0 0 10px 10px;
}
.log-raw-content {
    white-space: pre-wrap;
    word-break: break-all;
    color: #4a3f39;
    margin: 0;
}
.log-body-size {
    font-size: 11px;
    color: #666666;
    font-weight: 400;
    padding-left: 6px;
}

/* Content-type badge */
.log-content-type-badge {
    display: inline-block;
    padding: 3px 8px;
    border-radius: 5px;
    font-size: 10px;
    font-weight: 700;
    background: #007dbd;
    color: #ffffff;
    text-transform: uppercase;
    letter-spacing: 0.4px;
}
.log-line-count {
    font-size: 11px;
    color: #666666;
    font-weight: 400;
}

/* Timeline bar */
.log-timeline-bar {
    width: 100%;
    height: 6px;
    background: #f0f0f0;
    border-radius: 3px;
    margin-top: 10px;
    overflow: hidden;
}
.log-timeline-fill {
    height: 100%;
    border-radius: 3px;
    transition: width 0.6s ease;
}
.log-timeline-fill.speed-fast { background: #79a22e; }
.log-timeline-fill.speed-medium { background: #f0ad4e; }
.log-timeline-fill.speed-slow { background: #eb5202; }
.log-timeline-fill.speed-very-slow { background: #d9534f; }

/* Query parameters table */
.log-query-params-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    margin-bottom: 30px;
    border: 1px solid #e3e3e3;
    border-radius: 10px;
    overflow: hidden;
}
.log-query-params-table th,
.log-query-params-table td {
    padding: 10px 16px;
    text-align: left;
    border-bottom: 1px solid #f0f0f0;
    font-size: 13px;
}
.log-query-params-table tr:last-child td {
    border-bottom: none;
}
.log-query-params-table th {
    background: #f5f5f5;
    font-weight: 600;
    color: #666666;
    text-transform: uppercase;
    font-size: 11px;
    letter-spacing: 0.4px;
}
.log-query-params-table td:first-child {
    font-weight: 600;
    color: #eb5202;
    font-family: 'Courier New', monospace;
    width: 30%;
}
.log-query-params-table td:last-child {
    color: #4a3f39;
    font-family: 'Courier New', monospace;
    word-break: break-all;
}

/* Export dropdown */
.log-export-dropdown {
    position: relative;
    display: inline-block;
}
.log-export-dropdown-menu {
    display: none;
    position: absolute;
    right: 0;
    top: calc(100% + 4px);
    background: #ffffff;
    border: 1px solid #e3e3e3;
    border-radius: 10px;
    box-shadow: 0 8px 24px rgba(74,63,57,0.12), 0 2px 6px rgba(74,63,57,0.06);
    z-index: 100;
    min-width: 210px;
    padding: 4px;
    animation: dropdownFadeIn 0.12s ease-out;
}
@keyframes dropdownFadeIn {
    from { opacity: 0; transform: translateY(-4px); }
    to { opacity: 1; transform: translateY(0); }
}
.log-export-dropdown.open .log-export-dropdown-menu {
    display: block;
}
.log-export-dropdown-item {
    display: flex;
    align-items: center;
    gap: 10px;
    width: 100%;
    padding: 9px 12px;
    font-size: 13px;
    font-weight: 450;
    color: #4a3f39;
    background: none;
    border: none;
    border-radius: 7px;
    text-align: left;
    text-decoration: none;
    cursor: pointer;
    transition: background 0.12s ease;
}
.log-export-dropdown-item:hover {
    background: #f5f5f5;
    color: #4a3f39;
    text-decoration: none;
}
.log-export-dropdown-item svg {
    width: 16px;
    height: 16px;
    flex-shrink: 0;
    color: #666666;
}

/* JSON search */
.log-json-search {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 6px 12px;
    background: #fafafa;
    border: 1px solid #e3e3e3;
    border-top: none;
    border-bottom: none;
}
.log-json-search input {
    flex: 1;
    padding: 5px 10px;
    border: 1px solid #e3e3e3;
    border-radius: 6px;
    font-size: 12px;
    color: #4a3f39;
    background: #ffffff;
    outline: none;
    transition: border-color 0.15s ease;
}
.log-json-search input:focus {
    border-color: #007dbd;
    box-shadow: 0 0 0 2px rgba(0,125,189,0.08);
}
.log-json-search-count {
    font-size: 11px;
    color: #666666;
    white-space: nowrap;
}
.json-search-highlight {
    background: #fff1ad !important;
    border-radius: 2px;
    box-shadow: 0 0 0 1px #f0ad4e;
}
.json-search-dim {
    opacity: 0.3;
}

/* JSON path breadcrumb */
.log-json-path-bar {
    display: none;
    align-items: center;
    gap: 6px;
    padding: 5px 12px;
    background: #4a3f39;
    color: #ffffff;
    font-family: 'SFMono-Regular', 'Consolas', 'Liberation Mono', 'Courier New', monospace;
    font-size: 11px;
}
.log-json-path-bar.visible {
    display: flex;
}
.log-json-path-text {
    flex: 1;
    overflow-x: auto;
    white-space: nowrap;
}
.log-json-path-copy {
    background: none;
    border: 1px solid rgba(255,255,255,0.2);
    color: rgba(255,255,255,0.7);
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 10px;
    cursor: pointer;
    text-transform: uppercase;
    transition: all 0.12s ease;
}
.log-json-path-copy:hover {
    border-color: rgba(255,255,255,0.5);
    color: #ffffff;
}

/* Performance context card */
.log-perf-card {
    padding: 16px 20px;
    border-top: 1px solid #f0f0f0;
    grid-column: 1 / -1;
}
.log-perf-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 0;
    margin-top: 8px;
}
.log-perf-stat {
    text-align: center;
    padding: 8px 12px;
}
.log-perf-stat-value {
    font-size: 18px;
    font-weight: 700;
    color: #4a3f39;
}
.log-perf-stat-label {
    font-size: 10px;
    color: #999;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-top: 2px;
}

/* Related logs table */
.log-related-section {
    margin-top: 24px;
}
.log-related-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    border: 1px solid #e3e3e3;
    border-radius: 10px;
    overflow: hidden;
}
.log-related-table th,
.log-related-table td {
    padding: 10px 16px;
    text-align: left;
    border-bottom: 1px solid #f0f0f0;
    font-size: 12px;
}
.log-related-table tr:last-child td {
    border-bottom: none;
}
.log-related-table th {
    background: #f5f5f5;
    font-weight: 600;
    color: #999;
    text-transform: uppercase;
    font-size: 10px;
    letter-spacing: 0.5px;
}
.log-related-table a {
    color: #007dbd;
    text-decoration: none;
    font-weight: 500;
}
.log-related-table a:hover {
    text-decoration: underline;
}

/* Replay modal */
.log-replay-result {
    margin-top: 15px;
}
.log-replay-comparison {
    display: flex;
    gap: 12px;
    margin-bottom: 16px;
}
.log-replay-comparison > div {
    flex: 1;
    background: #ffffff;
    padding: 14px;
    border-radius: 10px;
    border: 1px solid #e3e3e3;
    text-align: center;
}
.log-replay-comparison .stat-value {
    font-size: 22px;
    font-weight: 700;
    color: #4a3f39;
}
.log-replay-comparison .stat-label {
    font-size: 10px;
    color: #999;
    text-transform: uppercase;
    letter-spacing: 0.4px;
}

/* Compare modal */
.log-compare-search {
    margin-bottom: 12px;
}
.log-compare-search input {
    width: 100%;
    padding: 9px 14px;
    border: 1px solid #e3e3e3;
    border-radius: 8px;
    font-size: 13px;
    color: #4a3f39;
    outline: none;
    transition: border-color 0.15s ease;
}
.log-compare-search input:focus {
    border-color: #007dbd;
    box-shadow: 0 0 0 2px rgba(0,125,189,0.08);
}
.log-compare-results {
    max-height: 200px;
    overflow-y: auto;
    border: 1px solid #e3e3e3;
    border-radius: 8px;
    margin-bottom: 15px;
    display: none;
}
.log-compare-result-item {
    padding: 10px 14px;
    cursor: pointer;
    border-bottom: 1px solid #f0f0f0;
    font-size: 12px;
    transition: background 0.12s ease;
}
.log-compare-result-item:last-child {
    border-bottom: none;
}
.log-compare-result-item:hover {
    background: #f5f5f5;
}
.log-compare-result-item.selected {
    background: #eaf4f8;
}
.log-compare-diff {
    display: none;
}
.log-compare-columns {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0;
}
.log-compare-column {
    overflow: auto;
}
.log-compare-column-header {
    padding: 8px 14px;
    background: #4a3f39;
    color: #ffffff;
    font-weight: 600;
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.4px;
    position: sticky;
    top: 0;
}
.log-compare-column-body {
    padding: 0;
    font-family: 'SFMono-Regular', 'Consolas', 'Liberation Mono', 'Courier New', monospace;
    font-size: 12px;
    max-height: 500px;
    overflow: auto;
}
.log-diff-line {
    padding: 2px 12px;
    white-space: pre-wrap;
    word-break: break-all;
}
.log-diff-line.added {
    background: #d4edda;
}
.log-diff-line.removed {
    background: #f8d7da;
}
.log-diff-line.unchanged {
    color: #666666;
}

/* Loading spinner */
.log-loading {
    text-align: center;
    color: #666666;
    font-size: 13px;
}
CSS;

echo $secureRenderer->renderTag(
    'style',
    [],
    $css,
    false
);
?>

<div class="log-detail-container">
    <!-- Header -->
    <div class="log-detail-header">
        <div>
            <div class="log-detail-title">
                <span class="log-status-badge <?= $escaper->escapeHtmlAttr($block->getStatusBadgeClass($logEntry->getResponseCode())) ?>">
                    <?= $escaper->escapeHtml($logEntry->getMethod()) ?>
                </span>
                <span class="log-status-url">
                    <?= $escaper->escapeHtml($logEntry->getEndpoint()) ?>
                </span>
                <?php if ($logEntry->isException()): ?>
                    <span class="log-exception-badge">EXCEPTION</span>
                <?php endif; ?>
            </div>
        </div>
        <div class="log-detail-actions">
            <!-- Export Dropdown -->
            <div class="log-export-dropdown" id="exportDropdown">
                <button type="button" class="log-action-btn" id="exportDropdownBtn">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                    <?= $escaper->escapeHtml(__('Export')) ?>
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:12px;height:12px;margin-left:-2px"><polyline points="6 9 12 15 18 9"/></svg>
                </button>
                <div class="log-export-dropdown-menu">
                    <button type="button" class="log-export-dropdown-item" id="copyCurlBtn">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
                        <?= $escaper->escapeHtml(__('Copy as cURL')) ?>
                    </button>
                    <a href="<?= $escaper->escapeUrl($block->getExportUrl('har')) ?>" class="log-export-dropdown-item">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                        <?= $escaper->escapeHtml(__('Download HAR')) ?>
                    </a>
                    <a href="<?= $escaper->escapeUrl($block->getExportUrl('http')) ?>" class="log-export-dropdown-item">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
                        <?= $escaper->escapeHtml(__('Download Raw HTTP')) ?>
                    </a>
                </div>
            </div>

            <!-- Replay Button -->
            <button type="button" class="log-action-btn log-action-btn--primary" id="replayBtn">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><polygon points="5 3 19 12 5 21 5 3"/></svg>
                <?= $escaper->escapeHtml(__('Replay')) ?>
            </button>

            <!-- Compare Button -->
            <button type="button" class="log-action-btn" id="compareBtn">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
                <?= $escaper->escapeHtml(__('Compare')) ?>
            </button>

            <span class="log-action-divider"></span>

            <button type="button" class="log-action-btn log-action-btn--ghost" onclick="location.href='<?= $escaper->escapeUrl($block->getBackUrl()) ?>'">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>
                <?= $escaper->escapeHtml(__('Back')) ?>
            </button>
            <form method="post" action="<?= $escaper->escapeUrl($block->getDeleteUrl()) ?>" style="display: inline;">
                <?= $block->getBlockHtml('formkey') ?>
                <button type="button" class="log-action-btn log-action-btn--danger" onclick="confirmDelete(this)">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
                    <?= $escaper->escapeHtml(__('Delete')) ?>
                </button>
            </form>
        </div>
    </div>

    <!-- Overview Grid -->
    <div class="log-detail-grid">
        <div class="log-detail-item">
            <div class="log-detail-item-label"><?= $escaper->escapeHtml(__('Log ID')) ?></div>
            <div class="log-detail-item-value">#<?= $escaper->escapeHtml($logEntry->getEntityId()) ?></div>
        </div>

        <div class="log-detail-item">
            <div class="log-detail-item-label"><?= $escaper->escapeHtml(__('Response Code')) ?></div>
            <div class="log-detail-item-value">
                <span class="log-status-badge <?= $escaper->escapeHtmlAttr($block->getStatusBadgeClass($logEntry->getResponseCode())) ?>">
                    <?= $escaper->escapeHtml($logEntry->getResponseCode() ?? 'N/A') ?>
                </span>
            </div>
        </div>

        <!-- Duration with Timeline Bar -->
        <div class="log-detail-item">
            <div class="log-detail-item-label"><?= $escaper->escapeHtml(__('Duration')) ?></div>
            <div class="log-detail-item-value">
                <?= $escaper->escapeHtml($duration !== null ? number_format($duration, 2) . ' ms' : 'N/A') ?>
            </div>
            <?php if ($duration !== null): ?>
                <?php
                $timelineClass = 'speed-fast';
                $timelineWidth = min(($duration / 100) * 100, 100);
                if ($duration >= 1000) {
                    $timelineClass = 'speed-very-slow';
                    $timelineWidth = 100;
                } elseif ($duration >= 500) {
                    $timelineClass = 'speed-slow';
                    $timelineWidth = min(($duration / 1000) * 100, 100);
                } elseif ($duration >= 100) {
                    $timelineClass = 'speed-medium';
                    $timelineWidth = min(($duration / 500) * 100, 100);
                }
                ?>
                <div class="log-timeline-bar">
                    <div class="log-timeline-fill <?= $escaper->escapeHtmlAttr($timelineClass) ?>"
                         style="width: <?= $escaper->escapeHtmlAttr(number_format($timelineWidth, 1)) ?>%"></div>
                </div>
            <?php endif; ?>
        </div>

        <div class="log-detail-item">
            <div class="log-detail-item-label"><?= $escaper->escapeHtml(__('Created At')) ?></div>
            <div class="log-detail-item-value">
                <?= $escaper->escapeHtml($logEntry->getCreatedAt() ?? 'N/A') ?>
            </div>
        </div>

        <div class="log-detail-item">
            <div class="log-detail-item-label"><?= $escaper->escapeHtml(__('IP Address')) ?></div>
            <div class="log-detail-item-value">
                <?= $escaper->escapeHtml($logEntry->getIpAddress() ?? 'N/A') ?>
            </div>
        </div>

        <!-- Store Name Resolution -->
        <div class="log-detail-item">
            <div class="log-detail-item-label"><?= $escaper->escapeHtml(__('Store')) ?></div>
            <div class="log-detail-item-value">
                <?= $escaper->escapeHtml($block->getStoreName($logEntry->getStoreId())) ?>
            </div>
        </div>

        <?php if ($logEntry->getCustomerId()): ?>
            <div class="log-detail-item">
                <div class="log-detail-item-label"><?= $escaper->escapeHtml(__('Customer ID')) ?></div>
                <div class="log-detail-item-value">
                    <?= $escaper->escapeHtml($logEntry->getCustomerId()) ?>
                </div>
            </div>
        <?php endif; ?>

        <?php if ($logEntry->getUserAgent()): ?>
            <div class="log-detail-item" style="grid-column: 1 / -1;">
                <div class="log-detail-item-label"><?= $escaper->escapeHtml(__('User Agent')) ?></div>
                <div class="log-detail-item-value">
                    <?= $escaper->escapeHtml($logEntry->getUserAgent()) ?>
                </div>
            </div>
        <?php endif; ?>

        <!-- Performance Context (loaded via AJAX) -->
        <div class="log-perf-card" id="perfContext" style="display:none;">
            <div class="log-detail-item-label"><?= $escaper->escapeHtml(__('Performance Context')) ?></div>
            <div class="log-perf-grid" id="perfGrid"></div>
        </div>
    </div>

    <!-- Query Parameters Table -->
    <?php if (!empty($queryParams)): ?>
        <div class="log-detail-section">
            <div class="log-detail-section-title"><?= $escaper->escapeHtml(__('Query Parameters')) ?></div>
            <table class="log-query-params-table">
                <thead>
                    <tr>
                        <th><?= $escaper->escapeHtml(__('Parameter')) ?></th>
                        <th><?= $escaper->escapeHtml(__('Value')) ?></th>
                    </tr>
                </thead>
                <tbody>
                    <?php foreach ($queryParams as $key => $value): ?>
                        <tr>
                            <td><?= $escaper->escapeHtml((string)$key) ?></td>
                            <td><?= $escaper->escapeHtml(is_array($value) ? implode(', ', $value) : (string)$value) ?></td>
                        </tr>
                    <?php endforeach; ?>
                </tbody>
            </table>
        </div>
    <?php endif; ?>

    <!-- Request Headers -->
    <?php if ($logEntry->getRequestHeaders()): ?>
        <div class="log-detail-section" data-section="request-headers">
            <div class="log-detail-section-title">
                <?= $escaper->escapeHtml(__('Request Headers')) ?>
                <?php if ($requestContentType): ?>
                    <span class="log-content-type-badge"><?= $escaper->escapeHtml($requestContentType) ?></span>
                <?php endif; ?>
            </div>
            <div class="log-tab-header">
                <div class="log-tab-bar">
                    <button type="button" class="log-tab-btn active" data-tab="pretty"><?= $escaper->escapeHtml(__('Pretty')) ?></button>
                    <button type="button" class="log-tab-btn" data-tab="raw"><?= $escaper->escapeHtml(__('Raw')) ?></button>
                </div>
                <div class="log-tab-actions">
                    <button type="button" class="log-tab-copy-btn" data-copy-target="request-headers"><?= $escaper->escapeHtml(__('Copy')) ?></button>
                </div>
            </div>
            <div class="log-tab-panel active" data-tab-panel="pretty">
                <div class="log-json-search">
                    <input type="text" placeholder="<?= $escaper->escapeHtmlAttr(__('Search JSON...')) ?>" data-search-section="request-headers"/>
                    <span class="log-json-search-count" data-search-count></span>
                </div>
                <div class="log-json-path-bar" data-json-path>
                    <span class="log-json-path-text" data-json-path-text></span>
                    <button type="button" class="log-json-path-copy" data-json-path-copy><?= $escaper->escapeHtml(__('Copy')) ?></button>
                </div>
                <div class="log-code-block" data-json="<?= $escaper->escapeHtmlAttr($block->formatJson($logEntry->getRequestHeaders())) ?>"></div>
            </div>
            <div class="log-tab-panel" data-tab-panel="raw">
                <div class="log-code-block"><pre class="log-raw-content"><?= $escaper->escapeHtml($logEntry->getRequestHeaders()) ?></pre></div>
            </div>
        </div>
    <?php endif; ?>

    <!-- Request Body -->
    <?php if ($logEntry->getRequestBody()): ?>
        <div class="log-detail-section" data-section="request-body">
            <div class="log-detail-section-title">
                <?= $escaper->escapeHtml(__('Request Body')) ?>
                <?php if ($requestContentType): ?>
                    <span class="log-content-type-badge"><?= $escaper->escapeHtml($requestContentType) ?></span>
                <?php endif; ?>
                <span class="log-body-size">(<?= $escaper->escapeHtml($block->formatBodySize($logEntry->getRequestBody())) ?>)</span>
                <?php if ($requestLineCount > 0): ?>
                    <span class="log-line-count"><?= $escaper->escapeHtml($requestLineCount . ' ' . ($requestLineCount === 1 ? 'line' : 'lines')) ?></span>
                <?php endif; ?>
            </div>
            <div class="log-tab-header">
                <div class="log-tab-bar">
                    <button type="button" class="log-tab-btn active" data-tab="pretty"><?= $escaper->escapeHtml(__('Pretty')) ?></button>
                    <button type="button" class="log-tab-btn" data-tab="raw"><?= $escaper->escapeHtml(__('Raw')) ?></button>
                </div>
                <div class="log-tab-actions">
                    <button type="button" class="log-tab-copy-btn" data-copy-target="request-body"><?= $escaper->escapeHtml(__('Copy')) ?></button>
                </div>
            </div>
            <div class="log-tab-panel active" data-tab-panel="pretty">
                <div class="log-json-search">
                    <input type="text" placeholder="<?= $escaper->escapeHtmlAttr(__('Search JSON...')) ?>" data-search-section="request-body"/>
                    <span class="log-json-search-count" data-search-count></span>
                </div>
                <div class="log-json-path-bar" data-json-path>
                    <span class="log-json-path-text" data-json-path-text></span>
                    <button type="button" class="log-json-path-copy" data-json-path-copy><?= $escaper->escapeHtml(__('Copy')) ?></button>
                </div>
                <div class="log-code-block" data-json="<?= $escaper->escapeHtmlAttr($block->formatJson($logEntry->getRequestBody())) ?>"></div>
            </div>
            <div class="log-tab-panel" data-tab-panel="raw">
                <div class="log-code-block"><pre class="log-raw-content"><?= $escaper->escapeHtml($logEntry->getRequestBody()) ?></pre></div>
            </div>
        </div>
    <?php endif; ?>

    <!-- Response Headers -->
    <?php if ($logEntry->getResponseHeaders()): ?>
        <div class="log-detail-section" data-section="response-headers">
            <div class="log-detail-section-title">
                <?= $escaper->escapeHtml(__('Response Headers')) ?>
                <?php if ($responseContentType): ?>
                    <span class="log-content-type-badge"><?= $escaper->escapeHtml($responseContentType) ?></span>
                <?php endif; ?>
            </div>
            <div class="log-tab-header">
                <div class="log-tab-bar">
                    <button type="button" class="log-tab-btn active" data-tab="pretty"><?= $escaper->escapeHtml(__('Pretty')) ?></button>
                    <button type="button" class="log-tab-btn" data-tab="raw"><?= $escaper->escapeHtml(__('Raw')) ?></button>
                </div>
                <div class="log-tab-actions">
                    <button type="button" class="log-tab-copy-btn" data-copy-target="response-headers"><?= $escaper->escapeHtml(__('Copy')) ?></button>
                </div>
            </div>
            <div class="log-tab-panel active" data-tab-panel="pretty">
                <div class="log-json-search">
                    <input type="text" placeholder="<?= $escaper->escapeHtmlAttr(__('Search JSON...')) ?>" data-search-section="response-headers"/>
                    <span class="log-json-search-count" data-search-count></span>
                </div>
                <div class="log-json-path-bar" data-json-path>
                    <span class="log-json-path-text" data-json-path-text></span>
                    <button type="button" class="log-json-path-copy" data-json-path-copy><?= $escaper->escapeHtml(__('Copy')) ?></button>
                </div>
                <div class="log-code-block" data-json="<?= $escaper->escapeHtmlAttr($block->formatJson($logEntry->getResponseHeaders())) ?>"></div>
            </div>
            <div class="log-tab-panel" data-tab-panel="raw">
                <div class="log-code-block"><pre class="log-raw-content"><?= $escaper->escapeHtml($logEntry->getResponseHeaders()) ?></pre></div>
            </div>
        </div>
    <?php endif; ?>

    <!-- Response Body -->
    <?php if ($logEntry->getResponseBody()): ?>
        <div class="log-detail-section" data-section="response-body">
            <div class="log-detail-section-title">
                <?= $escaper->escapeHtml(__('Response Body')) ?>
                <?php if ($responseContentType): ?>
                    <span class="log-content-type-badge"><?= $escaper->escapeHtml($responseContentType) ?></span>
                <?php endif; ?>
                <span class="log-body-size">(<?= $escaper->escapeHtml($block->formatBodySize($logEntry->getResponseBody())) ?>)</span>
                <?php if ($responseLineCount > 0): ?>
                    <span class="log-line-count"><?= $escaper->escapeHtml($responseLineCount . ' ' . ($responseLineCount === 1 ? 'line' : 'lines')) ?></span>
                <?php endif; ?>
            </div>
            <div class="log-tab-header">
                <div class="log-tab-bar">
                    <button type="button" class="log-tab-btn active" data-tab="pretty"><?= $escaper->escapeHtml(__('Pretty')) ?></button>
                    <button type="button" class="log-tab-btn" data-tab="raw"><?= $escaper->escapeHtml(__('Raw')) ?></button>
                </div>
                <div class="log-tab-actions">
                    <button type="button" class="log-tab-copy-btn" data-copy-target="response-body"><?= $escaper->escapeHtml(__('Copy')) ?></button>
                </div>
            </div>
            <div class="log-tab-panel active" data-tab-panel="pretty">
                <div class="log-json-search">
                    <input type="text" placeholder="<?= $escaper->escapeHtmlAttr(__('Search JSON...')) ?>" data-search-section="response-body"/>
                    <span class="log-json-search-count" data-search-count></span>
                </div>
                <div class="log-json-path-bar" data-json-path>
                    <span class="log-json-path-text" data-json-path-text></span>
                    <button type="button" class="log-json-path-copy" data-json-path-copy><?= $escaper->escapeHtml(__('Copy')) ?></button>
                </div>
                <div class="log-code-block" data-json="<?= $escaper->escapeHtmlAttr($block->formatJson($logEntry->getResponseBody())) ?>"></div>
            </div>
            <div class="log-tab-panel" data-tab-panel="raw">
                <div class="log-code-block"><pre class="log-raw-content"><?= $escaper->escapeHtml($logEntry->getResponseBody()) ?></pre></div>
            </div>
        </div>
    <?php endif; ?>

    <!-- Related Requests Section -->
    <div class="log-related-section" id="relatedSection" style="display:none;">
        <div class="log-detail-section-title"><?= $escaper->escapeHtml(__('Related Requests')) ?></div>
        <div id="relatedContent" class="log-loading"><?= $escaper->escapeHtml(__('Loading...')) ?></div>
    </div>
</div>

<!-- Replay Modal Container -->
<div id="replayModal" style="display:none;">
    <div class="log-loading" id="replayLoading"><?= $escaper->escapeHtml(__('Sending request...')) ?></div>
    <div class="log-replay-result" id="replayResult" style="display:none;">
        <div class="log-replay-comparison">
            <div>
                <div class="stat-label"><?= $escaper->escapeHtml(__('Original')) ?></div>
                <div class="stat-value" id="replayOrigStatus"></div>
                <div class="stat-label" id="replayOrigDuration"></div>
            </div>
            <div>
                <div class="stat-label"><?= $escaper->escapeHtml(__('Replay')) ?></div>
                <div class="stat-value" id="replayNewStatus"></div>
                <div class="stat-label" id="replayNewDuration"></div>
            </div>
        </div>
        <div class="log-tab-header">
            <div class="log-tab-bar">
                <button type="button" class="log-tab-btn active" data-tab="replay-pretty"><?= $escaper->escapeHtml(__('Pretty')) ?></button>
                <button type="button" class="log-tab-btn" data-tab="replay-raw"><?= $escaper->escapeHtml(__('Raw')) ?></button>
            </div>
        </div>
        <div class="log-tab-panel active" data-tab-panel="replay-pretty">
            <div class="log-code-block" id="replayPrettyBody"></div>
        </div>
        <div class="log-tab-panel" data-tab-panel="replay-raw">
            <div class="log-code-block"><pre class="log-raw-content" id="replayRawBody"></pre></div>
        </div>
    </div>
</div>

<!-- Compare Modal Container -->
<div id="compareModal" style="display:none;">
    <div class="log-compare-search">
        <input type="text" id="compareSearchInput" placeholder="<?= $escaper->escapeHtmlAttr(__('Search by endpoint, method, or ID...')) ?>"/>
    </div>
    <div class="log-compare-results" id="compareResults"></div>
    <div class="log-compare-diff" id="compareDiff">
        <div class="log-compare-columns">
            <div class="log-compare-column">
                <div class="log-compare-column-header"><?= $escaper->escapeHtml(__('Current')) ?> (#<?= $escaper->escapeHtml($logEntry->getEntityId()) ?>)</div>
                <div class="log-compare-column-body" id="compareLeft"></div>
            </div>
            <div class="log-compare-column">
                <div class="log-compare-column-header" id="compareRightHeader"><?= $escaper->escapeHtml(__('Selected')) ?></div>
                <div class="log-compare-column-body" id="compareRight"></div>
            </div>
        </div>
    </div>
</div>

<?php
$deleteTitle = $escaper->escapeJs(__('Delete Log Entry'));
$deleteContent = $escaper->escapeJs(__('Are you sure you want to delete this log entry?'));
$copiedLabel = $escaper->escapeJs(__('Copied!'));
$copyLabel = $escaper->escapeJs(__('Copy'));
$noMatchesLabel = $escaper->escapeJs(__('No matches'));
$matchesLabel = $escaper->escapeJs(__('%1 matches'));
$replayTitle = $escaper->escapeJs(__('Replay Request'));
$compareTitle = $escaper->escapeJs(__('Compare Requests'));
$currentId = (int)$logEntry->getEntityId();
$relatedUrl = $escaper->escapeJs($block->getRelatedUrl());
$statsUrl = $escaper->escapeJs($block->getStatsUrl());
$replayUrl = $escaper->escapeJs($block->getReplayUrl());
$compareUrl = $escaper->escapeJs($block->getCompareUrl());
$viewUrlBase = $escaper->escapeJs($block->getUrl('*/*/view'));
$formKey = $escaper->escapeJs($block->getBlockHtml('formkey'));
$logMethod = $escaper->escapeJs($logEntry->getMethod());
$logEndpoint = $escaper->escapeJs($block->getFullEndpointUrl());
$logRequestHeaders = $escaper->escapeJs($logEntry->getRequestHeaders() ?? '');
$logRequestBody = $escaper->escapeJs($logEntry->getRequestBody() ?? '');

$script = <<<JS
require(['jquery', 'Magento_Ui/js/modal/confirm', 'Magento_Ui/js/modal/modal', 'domReady!'], function(\$, confirmation, modal) {
    'use strict';

    var currentId = {$currentId};
    var formKeyHtml = '{$formKey}';
    var formKeyMatch = formKeyHtml.match(/value="([^"]+)"/);
    var formKeyValue = formKeyMatch ? formKeyMatch[1] : '';

    // Delete confirmation
    window.confirmDelete = function(button) {
        confirmation({
            title: '{$deleteTitle}',
            content: '{$deleteContent}',
            actions: {
                confirm: function() { \$(button).closest('form').submit(); }
            }
        });
    };

    // Format all visible JSON blocks
    function renderJsonBlocks(container) {
        var target = container || document;
        \$(target).find('.log-tab-panel.active .log-code-block[data-json]').each(function() {
            var el = \$(this);
            if (!el.data('json-rendered')) {
                var jsonData = el.attr('data-json');
                if (jsonData) {
                    el.html('').jsonView(jsonData).show();
                    el.data('json-rendered', true);
                }
            }
        });
    }

    // Tab switching
    \$(document).on('click', '.log-tab-btn', function() {
        var btn = \$(this);
        var section = btn.closest('.log-detail-section, #replayResult');
        var tabName = btn.attr('data-tab');
        section.find('.log-tab-btn').removeClass('active');
        btn.addClass('active');
        section.find('.log-tab-panel').removeClass('active');
        section.find('.log-tab-panel[data-tab-panel="' + tabName + '"]').addClass('active');
        if (tabName === 'pretty' || tabName === 'replay-pretty') {
            renderJsonBlocks(section);
        }
    });

    // Copy button
    \$(document).on('click', '.log-tab-copy-btn', function() {
        var btn = \$(this);
        var section = btn.closest('.log-detail-section');
        var text = '';
        var rawBlock = section.find('.log-tab-panel[data-tab-panel="raw"] .log-raw-content');
        if (rawBlock.length) { text = rawBlock.text(); }
        if (text && navigator.clipboard) {
            navigator.clipboard.writeText(text).then(function() {
                btn.text('{$copiedLabel}').addClass('copied');
                setTimeout(function() { btn.text('{$copyLabel}').removeClass('copied'); }, 1500);
            });
        }
    });

    // Export dropdown toggle
    \$('#exportDropdownBtn').on('click', function(e) {
        e.stopPropagation();
        \$('#exportDropdown').toggleClass('open');
    });
    \$(document).on('click', function() { \$('#exportDropdown').removeClass('open'); });

    // Copy as cURL
    \$('#copyCurlBtn').on('click', function() {
        var method = '{$logMethod}';
        var endpoint = '{$logEndpoint}';
        var headersRaw = '{$logRequestHeaders}';
        var body = '{$logRequestBody}';
        var curl = 'curl -X ' + method + " '" + endpoint + "'";
        if (headersRaw) {
            try {
                var headers = JSON.parse(headersRaw);
                for (var key in headers) {
                    if (headers.hasOwnProperty(key)) {
                        var val = Array.isArray(headers[key]) ? headers[key].join(', ') : headers[key];
                        curl += " \\\\\\n  -H '" + key + ': ' + val + "'";
                    }
                }
            } catch(e) {}
        }
        if (body) {
            curl += " \\\\\\n  -d '" + body.replace(/'/g, "'\\\\''") + "'";
        }
        if (navigator.clipboard) {
            navigator.clipboard.writeText(curl).then(function() {
                var btn = \$('#copyCurlBtn');
                var origText = btn.text();
                btn.text('{$copiedLabel}');
                setTimeout(function() { btn.text(origText); }, 1500);
            });
        }
        \$('#exportDropdown').removeClass('open');
    });

    // JSON Search
    var searchTimers = {};
    \$(document).on('input', '.log-json-search input', function() {
        var input = \$(this);
        var section = input.closest('.log-detail-section');
        var sectionName = input.attr('data-search-section');
        clearTimeout(searchTimers[sectionName]);
        searchTimers[sectionName] = setTimeout(function() {
            var term = input.val().trim().toLowerCase();
            var codeBlock = section.find('.log-tab-panel[data-tab-panel="pretty"] .log-code-block');
            var countEl = section.find('[data-search-count]');
            codeBlock.find('.json-search-highlight').removeClass('json-search-highlight');
            codeBlock.find('.json-search-dim').removeClass('json-search-dim');
            if (!term) { countEl.text(''); return; }
            var allNodes = codeBlock.find('.str, .num, .bool, .null, .key');
            var matchCount = 0;
            allNodes.each(function() {
                var node = \$(this);
                if (node.text().toLowerCase().indexOf(term) !== -1) {
                    node.addClass('json-search-highlight');
                    matchCount++;
                } else {
                    node.addClass('json-search-dim');
                }
            });
            countEl.text(matchCount === 0 ? '{$noMatchesLabel}' : matchCount + ' matches');
        }, 200);
    });

    // JSON Path Breadcrumb
    \$(document).on('click', '.log-code-block[data-json] .str, .log-code-block[data-json] .num, .log-code-block[data-json] .bool, .log-code-block[data-json] .null, .log-code-block[data-json] .key', function(e) {
        e.stopPropagation();
        var el = \$(this);
        var section = el.closest('.log-detail-section');
        var pathBar = section.find('[data-json-path]');
        var pathText = section.find('[data-json-path-text]');
        var parts = [];
        var current = el;
        while (current.length && !current.hasClass('log-code-block')) {
            if (current.hasClass('obj') || current.hasClass('arr')) {
                var keyEl = current.prev('.key');
                if (keyEl.length) {
                    parts.unshift(keyEl.text().replace(/"/g, ''));
                } else {
                    var parent = current.parent();
                    if (parent.hasClass('arr')) {
                        var idx = current.index();
                        parts.unshift('[' + idx + ']');
                    }
                }
            } else if (current.hasClass('str') || current.hasClass('num') || current.hasClass('bool') || current.hasClass('null') || current.hasClass('key')) {
                var prevKey = current.prev('.key');
                if (!prevKey.length) {
                    var parentLi = current.parent();
                    if (parentLi.length) {
                        prevKey = parentLi.find('> .key').first();
                    }
                }
                if (prevKey.length && parts.length === 0) {
                    parts.unshift(prevKey.text().replace(/"/g, ''));
                } else if (current.hasClass('key') && parts.length === 0) {
                    parts.unshift(current.text().replace(/"/g, ''));
                }
                var arrParent = current.closest('.arr > li, .arr > .item');
                if (arrParent.length) {
                    parts.unshift('[' + arrParent.index() + ']');
                }
            }
            current = current.parent();
        }
        var path = '\$' + (parts.length ? '.' + parts.join('.') : '');
        path = path.replace(/\.\[/g, '[');
        pathText.text(path);
        pathBar.addClass('visible');
    });

    \$(document).on('click', '[data-json-path-copy]', function() {
        var pathText = \$(this).siblings('[data-json-path-text]').text();
        if (pathText && navigator.clipboard) {
            navigator.clipboard.writeText(pathText);
        }
    });

    // Replay Modal
    var replayModal = \$('#replayModal');
    modal({ type: 'popup', responsive: true, title: '{$replayTitle}', buttons: [] }, replayModal);
    \$('#replayBtn').on('click', function() {
        replayModal.modal('openModal');
        \$('#replayLoading').show();
        \$('#replayResult').hide();
        \$.ajax({
            url: '{$replayUrl}',
            type: 'POST',
            data: { form_key: formKeyValue },
            dataType: 'json'
        }).done(function(data) {
            \$('#replayLoading').hide();
            if (data.error) {
                \$('#replayResult').html('<div class="message message-error">' + data.message + '</div>').show();
                return;
            }
            \$('#replayOrigStatus').text(data.original_status || 'N/A');
            \$('#replayOrigDuration').text((data.original_duration || 0).toFixed(2) + ' ms');
            \$('#replayNewStatus').text(data.replay_status || 'N/A');
            \$('#replayNewDuration').text((data.replay_duration || 0).toFixed(2) + ' ms');
            \$('#replayRawBody').text(data.replay_body || '');
            var prettyEl = \$('#replayPrettyBody');
            prettyEl.removeData('json-rendered');
            try {
                var parsed = JSON.parse(data.replay_body || '{}');
                prettyEl.attr('data-json', JSON.stringify(parsed, null, 2));
                prettyEl.html('').jsonView(JSON.stringify(parsed, null, 2));
            } catch(e) {
                prettyEl.text(data.replay_body || '');
            }
            \$('#replayResult').show();
        }).fail(function() {
            \$('#replayLoading').hide();
            \$('#replayResult').html('<div class="message message-error">Request failed.</div>').show();
        });
    });

    // Compare Modal
    var compareModal = \$('#compareModal');
    modal({
        type: 'popup',
        responsive: true,
        title: '{$compareTitle}',
        modalClass: 'log-compare-modal',
        buttons: []
    }, compareModal);

    var compareSearchTimer;
    \$('#compareBtn').on('click', function() {
        compareModal.modal('openModal');
        \$('#compareDiff').hide();
        \$('#compareResults').hide();
        \$('#compareSearchInput').val('').focus();
    });

    \$('#compareSearchInput').on('input', function() {
        var term = \$(this).val().trim();
        clearTimeout(compareSearchTimer);
        if (term.length < 2) { \$('#compareResults').hide(); return; }
        compareSearchTimer = setTimeout(function() {
            \$.ajax({
                url: '{$compareUrl}',
                data: { id: currentId, q: term },
                dataType: 'json'
            }).done(function(data) {
                var html = '';
                if (data.items && data.items.length) {
                    data.items.forEach(function(item) {
                        html += '<div class="log-compare-result-item" data-compare-id="' + item.entity_id + '">';
                        html += '<strong>#' + item.entity_id + '</strong> ';
                        html += '<span class="log-status-badge ' + item.badge_class + '">' + item.method + '</span> ';
                        html += item.endpoint + ' <small>(' + item.created_at + ')</small>';
                        html += '</div>';
                    });
                } else {
                    html = '<div style="padding:12px;color:#666;">No results found.</div>';
                }
                \$('#compareResults').html(html).show();
            });
        }, 300);
    });

    \$(document).on('click', '.log-compare-result-item', function() {
        var otherId = \$(this).data('compare-id');
        \$('.log-compare-result-item').removeClass('selected');
        \$(this).addClass('selected');
        \$.ajax({
            url: '{$compareUrl}',
            data: { id: currentId, other_id: otherId },
            dataType: 'json'
        }).done(function(data) {
            if (!data.current || !data.other) return;
            \$('#compareRightHeader').text('Selected (#' + otherId + ')');
            renderDiff(data.current, data.other);
            \$('#compareDiff').show();
        });
    });

    function renderDiff(current, other) {
        var leftLines = formatForDiff(current);
        var rightLines = formatForDiff(other);
        var leftHtml = '', rightHtml = '';
        var maxLen = Math.max(leftLines.length, rightLines.length);
        for (var i = 0; i < maxLen; i++) {
            var l = leftLines[i] || '';
            var r = rightLines[i] || '';
            if (l === r) {
                leftHtml += '<div class="log-diff-line unchanged">' + escHtml(l) + '</div>';
                rightHtml += '<div class="log-diff-line unchanged">' + escHtml(r) + '</div>';
            } else {
                leftHtml += '<div class="log-diff-line removed">' + escHtml(l) + '</div>';
                rightHtml += '<div class="log-diff-line added">' + escHtml(r) + '</div>';
            }
        }
        \$('#compareLeft').html(leftHtml);
        \$('#compareRight').html(rightHtml);

        // Sync scroll
        \$('#compareLeft, #compareRight').off('scroll.compare').on('scroll.compare', function() {
            var other = this.id === 'compareLeft' ? '#compareRight' : '#compareLeft';
            \$(other).scrollTop(\$(this).scrollTop());
        });
    }

    function formatForDiff(entry) {
        var lines = [];
        lines.push('METHOD: ' + (entry.method || ''));
        lines.push('ENDPOINT: ' + (entry.endpoint || ''));
        lines.push('STATUS: ' + (entry.response_code || ''));
        lines.push('DURATION: ' + (entry.duration || '') + ' ms');
        lines.push('');
        lines.push('--- REQUEST HEADERS ---');
        try {
            var rh = JSON.stringify(JSON.parse(entry.request_headers || '{}'), null, 2);
            lines = lines.concat(rh.split('\\n'));
        } catch(e) { lines.push(entry.request_headers || ''); }
        lines.push('');
        lines.push('--- REQUEST BODY ---');
        try {
            var rb = JSON.stringify(JSON.parse(entry.request_body || '{}'), null, 2);
            lines = lines.concat(rb.split('\\n'));
        } catch(e) { lines.push(entry.request_body || ''); }
        lines.push('');
        lines.push('--- RESPONSE BODY ---');
        try {
            var resb = JSON.stringify(JSON.parse(entry.response_body || '{}'), null, 2);
            lines = lines.concat(resb.split('\\n'));
        } catch(e) { lines.push(entry.response_body || ''); }
        return lines;
    }

    function escHtml(str) {
        var div = document.createElement('div');
        div.appendChild(document.createTextNode(str));
        return div.innerHTML;
    }

    // Load Related Requests
    \$.ajax({
        url: '{$relatedUrl}',
        dataType: 'json'
    }).done(function(data) {
        if (data.items && data.items.length) {
            var html = '<table class="log-related-table"><thead><tr>';
            html += '<th>ID</th><th>Method</th><th>Status</th><th>Duration</th><th>Date</th>';
            html += '</tr></thead><tbody>';
            data.items.forEach(function(item) {
                html += '<tr>';
                html += '<td><a href="{$viewUrlBase}id/' + item.entity_id + '/">#' + item.entity_id + '</a></td>';
                html += '<td><span class="log-status-badge ' + item.badge_class + '">' + item.method + '</span></td>';
                html += '<td>' + (item.response_code || 'N/A') + '</td>';
                html += '<td>' + (item.duration ? parseFloat(item.duration).toFixed(2) + ' ms' : 'N/A') + '</td>';
                html += '<td>' + item.created_at + '</td>';
                html += '</tr>';
            });
            html += '</tbody></table>';
            \$('#relatedContent').html(html);
            \$('#relatedSection').show();
        }
    });

    // Load Performance Context
    \$.ajax({
        url: '{$statsUrl}',
        dataType: 'json'
    }).done(function(data) {
        if (data && data.request_count > 0) {
            var html = '';
            html += '<div class="log-perf-stat"><div class="log-perf-stat-value">' + parseFloat(data.avg_duration).toFixed(1) + ' ms</div><div class="log-perf-stat-label">Avg Duration</div></div>';
            html += '<div class="log-perf-stat"><div class="log-perf-stat-value">' + parseFloat(data.min_duration).toFixed(1) + ' ms</div><div class="log-perf-stat-label">Min</div></div>';
            html += '<div class="log-perf-stat"><div class="log-perf-stat-value">' + parseFloat(data.max_duration).toFixed(1) + ' ms</div><div class="log-perf-stat-label">Max</div></div>';
            html += '<div class="log-perf-stat"><div class="log-perf-stat-value">' + data.request_count + '</div><div class="log-perf-stat-label">Total Requests</div></div>';
            if (data.percentile_rank !== undefined) {
                html += '<div class="log-perf-stat"><div class="log-perf-stat-value">' + parseFloat(data.percentile_rank).toFixed(0) + '%</div><div class="log-perf-stat-label">Faster Than</div></div>';
            }
            \$('#perfGrid').html(html);
            \$('#perfContext').show();
        }
    });

    // Initial render
    renderJsonBlocks();
});
JS;
echo $secureRenderer->renderTag(
    'script',
    [],
    $script,
    false
);
